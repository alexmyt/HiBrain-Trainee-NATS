## Тестовое задание №2 для backend-стажировки в [HiBrain](https://hibrain.ru/)

### Задача

- Реализовать микросервис api, основная задача которого - принимать запросы от клиента и направлять их в микросервис storage с помощью системы обмена сообщениями NATS. В качестве примера взаимодействия микросервисов необходимо реализовать тестовый маршрут GET api/test, который публикует сообщение в NATS.
- Реализовать микросервис storage, основная задача которого - принимать запросы от микросервиса api и вызывать соответствующие методы репозитория. В качестве примера взаимодействия микросервисов, необходимо подписаться на сообщение, опубликованное в микросервисе api и указать тестовый обработчик, который вызывает метод find репозитория test.
- **Стек технологий**:
  - TS
  - Node
  - NATS
  - typeORM
  - Postrgesql
  - Docker* (по желанию)

[Диаграмма последовательностей успешного выполнения запроса](https://drive.google.com/file/d/1Ggy8sdk-1VxbTbEXdxTiwyvean1zzt6z/view)

### Зависимости

Используется Docker-конейнеры для серверов NATS и PostgreSQL. Запуск контейнеров выполняется командой `docker-compose up -d`
При инициализации контейнера postgres выполняется загрузка тестовых данных в базу данных.

**Используемые пакеты**

- [HAPI](https://hapi.dev/) - HTTP-сервер
- [Joi](https://joi.dev/) - валидатор данных
- [NATS.js](https://github.com/nats-io/nats.js) - клиент NATS для Node.js
- [typeORM](https://typeorm.io/) - отображение данных СУБД в объекты JS

### Реализация

Приложение демонстрирует взаимодействие двух микросервисов через сервер обмена сообщений. Сервис API принимает запросы, публикует на сервере обмена сообщений и подписывается на получение ответа на опубликованное сообщение. Сервис storage отслеживает поступление сообщений, обрабатывает их и публикует ответы.

В качестве полезной нагрузки используется объект message, состоящий из уникального идентификатора, даты публикации, заголовка и тела сообщения:
```JSON
{
"id": 1,
"date": "2022-09-01T05:44:36.152Z",
"title": "test 1",
"content": "test content 1"
}
```

**Объекты программной реализации сервиса**
- src/
  - api/ - микросервис API
    - index.ts - файл запуска приложения HTTP-сервера
    - server.ts - реализация HTTP-сервера
    - routes/ - каталог с маршрутами
      - test.ts - тестовый маршрут и тестовый контроллер
  - storage/ - микросервис storage
    - index.ts - файл запуска приложения
    - service.ts - реализация микросервиса storage
    - data-surce.ts - подключение к базе данных
    - models/ - описания объектов метаданных
      - message.ts
    - handlers/ - обработчики сообщений, полученных микросервисом
      - TestHandler.ts 
  - common/ - общие объекты
    - constants.ts - общие константы, типы, интерфейсы
    - Transport.ts - класс для работы с соединением NATS
- test/ - тесты
- docker/postgres/ - файлы с тестовыми данными для 'посева' БД
- docker-compose.yml - конфигурация запускаемых Docker-контейнеров

#### Сервис API

Элементраный HTTP-сервер, принимающий запросы по протоколу HTTP и возвращающий список сообщений в формате JSON. При настройках по умолчанию сервер отвечает на запросы по адресу http://localhost:3000. Взаимодействует с сервисами storage через публикацию событий *storage.\**
Маршруты сервера:
- api/test - запрос списка сообщений
- api/test/{id} - запрос сообщения с определенным id

#### Сервис storage

При запуске подписывается на события, определенные в константе *StorageMethods* (файл *./src/common/constants.ts*). При получении сообщения вызывается обработчик TestHandler.ts. Для взаимодействия с СУБД PostgreSQL используется typeORM, модель тестового объекта message реализована в файле ./src/storage/models/message.ts

### Запуск приложения

Перед запуском приложения должны быть доступны серверы NATS и PostgreSQL. 

`npm run api` - запуск сервиса API 
`npm run storage` - запуск сервиса storage
`npm start` - запуск сервисов API и storage

### Конфигурирование

Конфигурацию по умолчанию можно изменить с помощью файла `.env` в корне проекта:
```env
# API
API_PORT = 3000
API_HOST = localhost

# Storage
NATS_SERVER = nats://localhost:4222
DB_HOST = localhost
DB_PORT = 5432
DB_NAME = test
DB_USER = test
DB_PWD = test
```